on:
  release:
    types:
      - created

name: Continuous integration

jobs:
  arch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Prepare arch package metadata
        run: |
          wget https://github.com/grumlimited/authenticator-rs/releases/download/0.2/authenticator-rs-0.2-x86_64.deb -O data/arch/authenticator-rs/authenticator-rs-0.2-x86_64.deb

          MD5_SUM=$(md5sum data/arch/authenticator-rs/authenticator-rs-0.2-x86_64.deb  | awk '{print $1}')
          awk -v q="'" -v MD5_SUM=$MD5_SUM -i inplace 'BEGINFILE{print "md5sums=(" q MD5_SUM q ")"}{print}' data/arch/authenticator-rs/PKGBUILD
          awk -i inplace 'BEGINFILE{print "pkgver=0.2"}{print}' data/arch/authenticator-rs/PKGBUILD

      - name: Validate PKGBUILD
        id: validate-pkgbuild
        uses: grumlimited/arch-pkgbuild-builder@b7d2351b4ff786b4fd9664a4bcf1db6c8b755d26
        with:
          debug: true
          target: pkgbuild
          pkgname: data/arch/authenticator-rs/

      - name: Create arch package checksum file
        run: |
          sudo chown -R $USER .
          md5sum data/arch/authenticator-rs/*.xz >> data/arch/authenticator-rs/authenticator-rs-0.2-1-x86_64.pkg.tar.xz.md5sum
